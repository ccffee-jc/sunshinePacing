# 变更提案: 代理进程分离与本地 Metrics HTTP

## 需求背景
当前 GUI 与代理转发运行在同一进程内，图表绘制与 UI 刷新可能与转发逻辑争用 CPU。为降低互相影响并便于扩展，计划将转发与绘制解耦，GUI 通过本地 HTTP 读取运行指标。

## 产品分析

### 目标用户与场景
- **用户群体:** 本地部署 Sunshine 代理的使用者与维护者
- **使用场景:** 运行中观察 pacing 效果与队列变化
- **核心痛点:** 同进程绘图影响转发稳定性，无法清晰隔离负载

### 价值主张与成功指标
- **价值主张:** 绘制与转发隔离，降低 GUI 负载对转发的影响
- **成功指标:** GUI 可稳定展示指标；代理转发与图表刷新互不干扰

### 人文关怀
仅本地监听，无需额外认证与外部访问，避免用户隐私泄露风险。

## 变更内容
1. 代理进程提供本地 HTTP Metrics 服务（动态端口），对外仅暴露运行指标。
2. GUI 启动代理子进程，通过 HTTP 拉取 Metrics，并刷新图表与文本。
3. GUI 停止时直接终止代理子进程，清理轮询。

## 影响范围
- **模块:** core, cli, gui-linux, gui-win
- **文件:** cmd/proxy/main.go, cmd/proxy-gui/main_linux.go, cmd/proxy-gui/main_windows.go, internal/core/*
- **API:** 新增本地 HTTP `/metrics`
- **数据:** 无持久化数据变更

## 核心场景

### 需求: 进程外 Metrics 服务
**模块:** core/cli/gui
GUI 通过 HTTP 拉取指标，绘制与转发解耦。

#### 场景: GUI 启动代理拉取数据
用户在 GUI 点击“启动”后开始获取指标。
- 预期结果1：GUI 启动代理子进程并获取 metrics 地址
- 预期结果2：GUI 每 500ms 拉取指标并刷新图表/统计
- 预期结果3：绘图与转发处于不同进程

### 需求: 停止代理进程
**模块:** gui
GUI 停止时需要回收子进程。

#### 场景: 用户点击停止
用户点击“停止”按钮。
- 预期结果1：终止代理子进程
- 预期结果2：停止 HTTP 轮询并更新状态

### 需求: Metrics 异常处理
**模块:** gui/core
Metrics 服务不可用时的容错。

#### 场景: Metrics 服务不可达
代理尚未启动或异常退出。
- 预期结果1：GUI 显示“无数据/连接失败”状态
- 预期结果2：保持重试并可恢复

## 风险评估
- **风险:** HTTP 服务暴露导致安全或性能隐患
- **缓解:** 仅绑定 127.0.0.1；设置读写超时与限频；指标字段只读
