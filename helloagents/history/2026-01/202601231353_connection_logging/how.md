# 技术设计: 连接日志与配置开关

## 技术方案
### 核心技术
- Go 标准库 log
- YAML 配置加载（gopkg.in/yaml.v3）

### 实现要点
- 在配置中新增 connection_log.enable 字段，默认关闭。
- Session 记录每个端口最后一次已记录的客户端地址，用于判定 UDP 首次连接日志。
- UDP 外部读到新客户端时输出日志，包含端口、流类型、客户端地址。
- TCP accept 时输出日志，包含端口、客户端地址、内部目标地址。

## 架构决策 ADR
### ADR-003: 连接日志默认关闭
**上下文:** 连接日志对排障有价值，但在高频流量下会产生大量输出。
**决策:** 增加配置开关，默认关闭。
**理由:** 兼顾可观测性与性能。
**替代方案:** 默认开启 → 拒绝原因: 噪音大且影响性能。
**影响:** 需要在配置文档与示例中说明。

## 安全与性能
- **安全:** 日志仅记录连接信息，不记录敏感内容。
- **性能:** 仅在开启时输出，UDP 去重日志避免重复输出。

## 测试与部署
- **测试:** 运行 go test ./...；手动启动验证连接日志是否触发。
- **部署:** 修改 proxy.yml 开启连接日志。
